!function(){function t(t){var a=this,e=t.container;a.options=t,click=a.click.bind(a),e.addEventListener("click",click,!1),e.addEventListener("contextmenu",click,!1)}function a(t){var a=this;a.options=t,a.boxes=t.container,a.boxes.classList.add("mine-game"),a.blanks=-1,a.total=0,a.control={setLevel:a.setLevel.bind(a),restart:a.restart.bind(a)},a.setLevel(t.level||0)}t.prototype={click:function(t){t.preventDefault(),this.call("click",t)},call:function(t,a){var e,i=this,s=i.options["on"+t],n={type:t};for(e in a)n[e]=a[e];s&&s(n)}},a.prototype={levels:[{width:10,height:10,mines:10},{width:16,height:16,mines:40},{width:30,height:16,mines:99}],setLevel:function(t){this.level=t,this.level_data=this.levels[t],this.restart()},callback:function(t,a){var e=this.options["cb_"+t];e&&e.call(this,a)},click:function(t){var a=this;if(a.blanks){var e=Array.prototype.indexOf.call(a.items,t.target);if(2==t.button){if(a.blanks<0)return;a.data[e].open||((a.data[e].marked=!a.data[e].marked)?(a.items[e].classList.add("mine"),a.mine_left--):(a.items[e].classList.remove("mine"),a.mine_left++),a.callback("mine_left",a.mine_left))}else a.blanks<0&&a.newGame(e),a.data[e].open?a.validate(e)?a.spread(e):a.spark(e):a.open(e)}},getSurroundings:function(t){function a(a){a!=t&&e.push(a),a%i&&e.push(a-1),(a+1)%i&&e.push(a+1)}var e=[],i=this.level_data.width;return t>=i&&a(t-i),a(t),t+i<this.total&&a(t+i),e},newGame:function(t){var a,e,i,s=this,n=s.level_data.mines,l=s.total-9,r=Math.floor(t/s.level_data.width),o=t%s.level_data.width;for(s.blanks=s.total-s.level_data.mines,s.data=[],a=0,r&&r!=s.level_data.height-1||a++,o&&o!=s.level_data.width-1||a++,a--&&(l+=3,a&&(l+=2)),a=0;a<s.total;a++)i=Math.abs(Math.floor(a/s.level_data.width)-r)<=1&&Math.abs(a%s.level_data.width-o)<=1,e={mine:!i&&n/l>Math.random(),num:0},s.data.push(e),e.mine&&n--,i||l--;for(a=0;a<s.total;a++)s.data[a].mine&&s.getSurroundings(a).forEach(function(t){s.data[t].num++});s.callback("start"),s.startTimer()},clearTimer:function(t){this.timer&&(clearInterval(this.timer),this.timer=null),t&&this.callback("timer",0)},startTimer:function(){var t=0,a=this;a.clearTimer(!0),a.timer=setInterval(function(){t++,a.callback("timer",t)},1e3)},restart:function(){this.total=this.level_data.width*this.level_data.height;var t,a,e=[];for(t=0;t<this.level_data.height;t++){for(a=0;a<this.level_data.width;a++)e.push("<span class=close></span>");e.push("<br>")}this.boxes.innerHTML=e.join(""),this.items=this.boxes.querySelectorAll("span"),this.mine_left=this.level_data.mines,this.callback("mine_left",this.mine_left),this.blanks=-1,this.clearTimer(!0),this.callback("ready")},validate:function(t){var a=0,e=0,i=this;return i.data[t].open&&(e=1,i.getSurroundings(t).forEach(function(t){!i.data[t].mine&&i.data[t].marked&&(a=1),i.data[t].mine^i.data[t].marked&&(e=0)}),a&&i.lose(-1)),e},spread:function(t){this.getSurroundings(t).forEach(this.open.bind(this))},spark:function(t){function a(){i=!i,e.getSurroundings(t).forEach(function(t){if(!e.data[t].open&&!e.data[t].marked){var a=e.items[t].classList;i?a.add("spark"):a.remove("spark")}})}var e=this,i=!1;a(),setTimeout(a,200)},open:function(t){if(!this.data[t].open&&!this.data[t].marked)if(this.data[t].mine)this.lose(t);else if(this.items[t].className="open",this.data[t].open=1,this.blanks--,this.data[t].num?this.items[t].innerHTML=this.data[t].num:this.spread(t),!this.blanks){for(this.callback("win"),t=0;t<this.total;t++)this.data[t].mine&&!this.data[t].marked&&this.items[t].classList.add("mine");this.clearTimer(),this.callback("mine_left",0)}},lose:function(t){t>=0&&(this.items[t].className="wrong mine"),this.blanks=0,this.callback("lose"),this.clearTimer();for(var a=0;a<this.total;a++)!this.data[a].mine&&this.data[a].marked?this.items[a].className="wrong":this.data[a].mine&&!this.data[a].marked&&this.items[a].classList.add("mine")}},window.Mine=function(e){var i=new a(e);return new t({container:e.container,onclick:i.click.bind(i)}),i.control}}();